<!DOCTYPE html>
<html>
<head>
    <script type="module" src="https://md-block.verou.me/md-block.js"></script>
    <script type="text/javascript" src="https://unpkg.com/showdown/dist/showdown.min.js"></script>
    <link rel="stylesheet" href="./css/splendor.css">
    <link rel="stylesheet" href="./css/form.css">
    <title>Ask Gemini (for Code Bases)!</title>
    <script>
        function generateUUID() { // Public Domain/MIT
            var d = new Date().getTime();//Timestamp
            var d2 = ((typeof performance !== 'undefined') && performance.now && (performance.now()*1000)) || 0;//Time in microseconds since page-load or 0 if unsupported
            return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
                var r = Math.random() * 16;//random number between 0 and 16
                if(d > 0){//Use timestamp until depleted
                    r = (d + r)%16 | 0;
                    d = Math.floor(d/16);
                } else {//Use microseconds since page-load if supported
                    r = (d2 + r)%16 | 0;
                    d2 = Math.floor(d2/16);
                }
                return (c === 'x' ? r : (r & 0x3 | 0x8)).toString(16);
            });
        }
        window.onload = function() {
            window.cacheKey = generateUUID();
        };
    </script>
</head>
<body>

<h3>Ask Gemini a question about your code base.</h3>

<div style="text-align:center">
    <input type="text" class="cs-input" id="userInput" size=70 placeholder="Enter your query">
    <button class="cs-button-solid cs-submit" id="submit_button" onclick="queryServer()">Submit</button>
</div>
<div style="text-align:center">
    <input type="checkbox" id="includeCodeCheckbox" checked="true">
    <label for="includeCodeCheckbox">Include code</label>
</div>

<div id = "output"></div>

<script>
  function queryServer() {
    document.getElementById("submit_button").disabled = true;
    var converter = new showdown.Converter();

    var userInput = document.getElementById("userInput").value;
    document.getElementById("output").innerHTML = converter.makeHtml("<p>Sending query and waiting for a response...</p>");

    var data = JSON.stringify({ 
        message: userInput,
        include_code: document.getElementById("includeCodeCheckbox").checked,
        cache_key: window.cacheKey
     });

    var serverUrl = "http://127.0.0.1:5000/query/"; 

    var xhr = new XMLHttpRequest();
    xhr.open("POST", serverUrl, true);
    xhr.setRequestHeader("Content-Type", "application/json");

    xhr.onreadystatechange = function() {
      if (this.readyState === XMLHttpRequest.DONE && this.status === 200) {
        response = JSON.parse(this.responseText);
        var markdownOutput = response.answer; 
        console.log("Received: " + response.answer);
        document.getElementById("output").innerHTML = converter.makeHtml(markdownOutput);
        document.getElementById("submit_button").disabled = false;

      } else if (this.status !== 200) {
        document.getElementById("output").src = converter.makeHtml("<p>Error: " + this.status + "</p>");
        document.getElementById("submit_button").disabled = false;
      }
    };

    xhr.send(data);
  }
</script>

</body>
</html>
